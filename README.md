# 上下文场景感知增强

**让你的 Bot 在群聊中不再"抢答"别人的问题**

---

## 解决什么问题？

你的 Bot 是不是经常这样：

- 小明问小红："你吃饭了吗？" → Bot 抢答："我还没吃呢！"
- 群友们在聊天 → Bot 主动插话，还以为别人在问它
- 被主动回复插件触发后，把所有问题都当成问自己的

**这个插件就是来解决这个问题的。**

---

## 效果

安装后，Bot 会收到这样的场景提示：

```
当前消息: 小明 → 小红
【重要】小明 正在和 小红 对话，不是在问你！
你是主动加入的，不要把别人的问题当成问你的。
```

Bot 就会明白：哦，这不是问我的，我该旁观或者以补充的身份说话。

| 场景 | 以前 | 现在 |
|------|------|------|
| A 问 B 问题 | Bot 抢答 | Bot 知道不是问自己，选择旁观或补充 |
| @Bot | 正常回复 | 正常回复 |
| 回复 Bot 消息 | 正常回复 | 正常回复 |
| 主动触发 | 以为都在问自己 | 清楚知道谁在和谁说话 |

---

## 配置项

| 配置 | 说明 | 默认值 |
|------|------|--------|
| `enable` | 启用插件 | `true` |
| `bot_names` | Bot 的昵称列表，用于检测被提及 | `[]` |
| `max_history` | 每个群保留的消息数 | `50` |
| `max_groups` | 最大缓存群数（LRU 淘汰） | `100` |
| `dialogue_window` | 注入 LLM 的对话流条数 | `8` |
| `enable_dialogue_flow` | 显示对话流（谁→谁） | `true` |
| `enable_context_hint` | 显示行为指导 | `true` |
| `only_group_chat` | 仅群聊生效 | `true` |

---

## 和框架功能的关系

| 框架功能 | 要不要开？ | 说明 |
|---------|-----------|------|
| **群聊上下文感知增强** | ✅ 开 | 本插件是补充，不冲突 |
| **上下文压缩** | ✅ 开 | 不影响，各管各的 |
| **主动回复** | ✅ 开 | 正是为了配合主动回复设计的 |
| **LongTermMemory** | ✅ 开 | 完全兼容，协同工作 |

**本插件只做加法，不改框架任何东西。**

---

## 原理

纯规则分析，零额外 LLM 调用：

1. 监听所有消息，分析 @、回复、上下文推断出"谁在和谁说话"
2. 在 LLM 请求前注入场景描述
3. 告诉 LLM：这条消息是对谁说的、你是被叫的还是主动插话的、该怎么回应

---

**让 Bot 学会"察言观色"，不再尬聊。**
